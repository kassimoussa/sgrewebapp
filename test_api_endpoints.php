<?php

/**
 * Script de test pour tous les nouveaux endpoints API SGRE
 * Usage: php test_api_endpoints.php
 */

class ApiTester
{
    private $baseUrl;
    private $token;
    private $results = [];

    public function __construct($baseUrl = 'http://localhost/sgreweb/public/api/v1')
    {
        $this->baseUrl = rtrim($baseUrl, '/');
    }

    public function runAllTests()
    {
        echo "üöÄ D√©but des tests API SGRE\n";
        echo "Base URL: {$this->baseUrl}\n\n";

        // 1. Test authentification et r√©cup√©ration du token
        $this->testAuth();

        if (!$this->token) {
            echo "‚ùå Impossible de continuer sans token d'authentification\n";
            return;
        }

        // 2. Tests des nouveaux endpoints
        $this->testRefreshToken();
        $this->testEmployeeSearch();
        $this->testEmployeePhotoUpdate();
        $this->testContractManagement();
        $this->testDashboardStats();
        $this->testMonthlyConfirmations();
        $this->testProfileDocuments();

        // 3. R√©sum√© des r√©sultats
        $this->showResults();
    }

    private function testAuth()
    {
        echo "üìù Test 1: Authentification\n";
        
        // Login avec donn√©es de test
        $loginData = [
            'identifiant' => 'test@example.com', // √Ä adapter selon vos donn√©es
            'mot_de_passe' => 'password123'
        ];

        $response = $this->makeRequest('POST', '/auth/login', $loginData);
        
        if ($response && isset($response['success']) && $response['success']) {
            $this->token = $response['data']['token'];
            $this->addResult('auth_login', true, 'Login r√©ussi');
            echo "   ‚úÖ Login r√©ussi\n";
        } else {
            $this->addResult('auth_login', false, '√âchec du login');
            echo "   ‚ùå √âchec du login\n";
            
            // Essayer avec des donn√©es par d√©faut
            echo "   üîÑ Tentative avec donn√©es par d√©faut...\n";
            $defaultData = [
                'identifiant' => 'admin@admin.com',
                'mot_de_passe' => 'password'
            ];
            
            $response = $this->makeRequest('POST', '/auth/login', $defaultData);
            if ($response && isset($response['success']) && $response['success']) {
                $this->token = $response['data']['token'];
                $this->addResult('auth_login_default', true, 'Login avec donn√©es par d√©faut r√©ussi');
                echo "   ‚úÖ Login avec donn√©es par d√©faut r√©ussi\n";
            }
        }
        echo "\n";
    }

    private function testRefreshToken()
    {
        echo "üîÑ Test 2: Refresh Token\n";
        
        $response = $this->makeRequest('POST', '/auth/refresh', [
            'refresh_token' => $this->token
        ]);
        
        if ($response && isset($response['success']) && $response['success']) {
            $this->addResult('auth_refresh', true, 'Token refresh r√©ussi');
            echo "   ‚úÖ Token refresh r√©ussi\n";
        } else {
            $this->addResult('auth_refresh', false, '√âchec du token refresh');
            echo "   ‚ùå √âchec du token refresh\n";
        }
        echo "\n";
    }

    private function testEmployeeSearch()
    {
        echo "üîç Test 3: Recherche d'employ√©s\n";
        
        // Test recherche par pr√©nom
        $searchData = [
            'prenom' => 'Marie'
        ];
        
        $response = $this->makeRequest('POST', '/employees/search', $searchData);
        
        if ($response && isset($response['success']) && $response['success']) {
            $count = count($response['data']['employees']);
            $this->addResult('employee_search', true, "Recherche r√©ussie - {$count} r√©sultats");
            echo "   ‚úÖ Recherche r√©ussie - {$count} r√©sultats trouv√©s\n";
        } else {
            $this->addResult('employee_search', false, '√âchec de la recherche');
            echo "   ‚ùå √âchec de la recherche\n";
        }
        echo "\n";
    }

    private function testEmployeePhotoUpdate()
    {
        echo "üì∏ Test 4: Mise √† jour photo employ√©\n";
        
        // D'abord, r√©cup√©rer la liste des employ√©s pour avoir un ID
        $employeesResponse = $this->makeRequest('GET', '/employees');
        
        if ($employeesResponse && isset($employeesResponse['data']['data']) && !empty($employeesResponse['data']['data'])) {
            $employeeId = $employeesResponse['data']['data'][0]['id'];
            
            // Photo factice en base64 (pixel transparent)
            $fakePhoto = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
            
            $photoData = [
                'photo' => $fakePhoto
            ];
            
            $response = $this->makeRequest('PUT', "/employees/{$employeeId}/photo", $photoData);
            
            if ($response && isset($response['success']) && $response['success']) {
                $this->addResult('employee_photo', true, 'Mise √† jour photo r√©ussie');
                echo "   ‚úÖ Mise √† jour photo r√©ussie pour l'employ√© {$employeeId}\n";
            } else {
                $this->addResult('employee_photo', false, '√âchec mise √† jour photo');
                echo "   ‚ùå √âchec mise √† jour photo\n";
            }
        } else {
            $this->addResult('employee_photo', false, 'Aucun employ√© trouv√© pour le test');
            echo "   ‚ö†Ô∏è Aucun employ√© trouv√© pour le test\n";
        }
        echo "\n";
    }

    private function testContractManagement()
    {
        echo "üìù Test 5: Gestion des contrats\n";
        
        // Test r√©cup√©ration des contrats d'un employ√©
        $employeesResponse = $this->makeRequest('GET', '/employees');
        
        if ($employeesResponse && isset($employeesResponse['data']['data']) && !empty($employeesResponse['data']['data'])) {
            $employeeId = $employeesResponse['data']['data'][0]['id'];
            
            // Test historique des contrats
            $contractsResponse = $this->makeRequest('GET', "/employees/{$employeeId}/contracts");
            
            if ($contractsResponse && isset($contractsResponse['success']) && $contractsResponse['success']) {
                $contractCount = count($contractsResponse['data']['contracts']);
                $this->addResult('employee_contracts', true, "Historique contrats r√©cup√©r√© - {$contractCount} contrats");
                echo "   ‚úÖ Historique contrats r√©cup√©r√© - {$contractCount} contrats\n";
                
                // Test cr√©ation d'un nouveau contrat
                $newContractData = [
                    'type_emploi' => 'M√©nage',
                    'salaire_mensuel' => 50000,
                    'date_debut' => date('Y-m-d', strtotime('+1 day'))
                ];
                
                $newContractResponse = $this->makeRequest('POST', "/employees/{$employeeId}/contracts", $newContractData);
                
                if ($newContractResponse && isset($newContractResponse['success'])) {
                    if ($newContractResponse['success']) {
                        $this->addResult('contract_create', true, 'Nouveau contrat cr√©√©');
                        echo "   ‚úÖ Nouveau contrat cr√©√©\n";
                        
                        $contractId = $newContractResponse['data']['contract']['id'];
                        
                        // Test terminaison de contrat
                        $terminateData = [
                            'date_fin' => date('Y-m-d', strtotime('+30 days')),
                            'motif' => 'Test de terminaison de contrat'
                        ];
                        
                        $terminateResponse = $this->makeRequest('PUT', "/contracts/{$contractId}/terminate", $terminateData);
                        
                        if ($terminateResponse && isset($terminateResponse['success']) && $terminateResponse['success']) {
                            $this->addResult('contract_terminate', true, 'Contrat termin√© avec succ√®s');
                            echo "   ‚úÖ Contrat termin√© avec succ√®s\n";
                        } else {
                            $this->addResult('contract_terminate', false, '√âchec terminaison contrat');
                            echo "   ‚ùå √âchec terminaison contrat\n";
                        }
                    } else {
                        $message = $newContractResponse['message'] ?? 'Erreur inconnue';
                        $this->addResult('contract_create', false, "√âchec cr√©ation contrat: {$message}");
                        echo "   ‚ùå √âchec cr√©ation contrat: {$message}\n";
                    }
                } else {
                    $this->addResult('contract_create', false, 'Erreur requ√™te cr√©ation contrat');
                    echo "   ‚ùå Erreur requ√™te cr√©ation contrat\n";
                }
            } else {
                $this->addResult('employee_contracts', false, '√âchec r√©cup√©ration contrats');
                echo "   ‚ùå √âchec r√©cup√©ration contrats\n";
            }
        } else {
            $this->addResult('contract_management', false, 'Aucun employ√© trouv√©');
            echo "   ‚ö†Ô∏è Aucun employ√© trouv√© pour tester les contrats\n";
        }
        echo "\n";
    }

    private function testDashboardStats()
    {
        echo "üìä Test 6: Dashboard et statistiques\n";
        
        // Test statistiques compl√®tes
        $statsResponse = $this->makeRequest('GET', '/dashboard/stats');
        
        if ($statsResponse && isset($statsResponse['success']) && $statsResponse['success']) {
            $totalEmployees = $statsResponse['data']['overview']['total_employees'];
            $this->addResult('dashboard_stats', true, "Statistiques r√©cup√©r√©es - {$totalEmployees} employ√©s");
            echo "   ‚úÖ Statistiques r√©cup√©r√©es - {$totalEmployees} employ√©s\n";
        } else {
            $this->addResult('dashboard_stats', false, '√âchec r√©cup√©ration statistiques');
            echo "   ‚ùå √âchec r√©cup√©ration statistiques\n";
        }
        
        // Test r√©sum√© dashboard
        $summaryResponse = $this->makeRequest('GET', '/dashboard/summary');
        
        if ($summaryResponse && isset($summaryResponse['success']) && $summaryResponse['success']) {
            $activeContracts = $summaryResponse['data']['active_contracts'];
            $this->addResult('dashboard_summary', true, "R√©sum√© r√©cup√©r√© - {$activeContracts} contrats actifs");
            echo "   ‚úÖ R√©sum√© r√©cup√©r√© - {$activeContracts} contrats actifs\n";
        } else {
            $this->addResult('dashboard_summary', false, '√âchec r√©cup√©ration r√©sum√©');
            echo "   ‚ùå √âchec r√©cup√©ration r√©sum√©\n";
        }
        
        // Test export employ√©s
        $exportResponse = $this->makeRequest('GET', '/reports/employees?format=json');
        
        if ($exportResponse && isset($exportResponse['success']) && $exportResponse['success']) {
            $recordCount = $exportResponse['data']['total_records'];
            $this->addResult('employee_export', true, "Export r√©ussi - {$recordCount} enregistrements");
            echo "   ‚úÖ Export r√©ussi - {$recordCount} enregistrements\n";
        } else {
            $this->addResult('employee_export', false, '√âchec export employ√©s');
            echo "   ‚ùå √âchec export employ√©s\n";
        }
        echo "\n";
    }

    private function testMonthlyConfirmations()
    {
        echo "‚úÖ Test 7: Confirmations mensuelles\n";
        
        // Test confirmations en attente
        $pendingResponse = $this->makeRequest('GET', '/monthly-confirmations/pending');
        
        if ($pendingResponse && isset($pendingResponse['success']) && $pendingResponse['success']) {
            $pendingCount = $pendingResponse['data']['total_pending'];
            $this->addResult('confirmations_pending', true, "Confirmations en attente: {$pendingCount}");
            echo "   ‚úÖ Confirmations en attente r√©cup√©r√©es: {$pendingCount}\n";
        } else {
            $this->addResult('confirmations_pending', false, '√âchec r√©cup√©ration confirmations en attente');
            echo "   ‚ùå √âchec r√©cup√©ration confirmations en attente\n";
        }
        
        // Test statistiques confirmations
        $statsResponse = $this->makeRequest('GET', '/monthly-confirmations/statistics');
        
        if ($statsResponse && isset($statsResponse['success']) && $statsResponse['success']) {
            $totalConfirmations = $statsResponse['data']['total_confirmations'];
            $this->addResult('confirmations_stats', true, "Statistiques confirmations: {$totalConfirmations}");
            echo "   ‚úÖ Statistiques confirmations: {$totalConfirmations}\n";
        } else {
            $this->addResult('confirmations_stats', false, '√âchec statistiques confirmations');
            echo "   ‚ùå √âchec statistiques confirmations\n";
        }
        
        // Test confirmation directe d'un employ√©
        $employeesResponse = $this->makeRequest('GET', '/employees');
        
        if ($employeesResponse && isset($employeesResponse['data']['data']) && !empty($employeesResponse['data']['data'])) {
            $employeeId = $employeesResponse['data']['data'][0]['id'];
            
            $confirmationData = [
                'mois' => (int)date('n'),
                'annee' => (int)date('Y'),
                'commentaire' => 'Test de confirmation automatique'
            ];
            
            $confirmResponse = $this->makeRequest('POST', "/employees/{$employeeId}/monthly-confirmations", $confirmationData);
            
            if ($confirmResponse && isset($confirmResponse['success'])) {
                if ($confirmResponse['success']) {
                    $this->addResult('employee_confirmation', true, 'Confirmation employ√© r√©ussie');
                    echo "   ‚úÖ Confirmation employ√© r√©ussie\n";
                } else {
                    $message = $confirmResponse['message'] ?? 'Erreur inconnue';
                    $this->addResult('employee_confirmation', false, "√âchec confirmation: {$message}");
                    echo "   ‚ö†Ô∏è √âchec confirmation (probablement d√©j√† confirm√©): {$message}\n";
                }
            } else {
                $this->addResult('employee_confirmation', false, 'Erreur requ√™te confirmation');
                echo "   ‚ùå Erreur requ√™te confirmation\n";
            }
        }
        echo "\n";
    }

    private function testProfileDocuments()
    {
        echo "üìÑ Test 8: Documents profil employeur\n";
        
        // Document factice en base64 (petit PDF)
        $fakeDocument = 'data:application/pdf;base64,JVBERi0xLjQKJcOBw6DCgsOCw4PDhMOFw4bDh8OIw4nDisOLw4zDjcOOw4/DkA==';
        
        $documentData = [
            'type_document' => 'piece_identite',
            'document' => $fakeDocument,
            'nom_document' => 'Test_Document_ID.pdf'
        ];
        
        $response = $this->makeRequest('POST', '/profile/documents', $documentData);
        
        if ($response && isset($response['success']) && $response['success']) {
            $this->addResult('profile_documents', true, 'Upload document profil r√©ussi');
            echo "   ‚úÖ Upload document profil r√©ussi\n";
        } else {
            $this->addResult('profile_documents', false, '√âchec upload document profil');
            echo "   ‚ùå √âchec upload document profil\n";
        }
        echo "\n";
    }

    private function makeRequest($method, $endpoint, $data = null)
    {
        $url = $this->baseUrl . $endpoint;
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
        
        // Headers
        $headers = [
            'Content-Type: application/json',
            'Accept: application/json'
        ];
        
        if ($this->token) {
            $headers[] = 'Authorization: Bearer ' . $this->token;
        }
        
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        
        // Data
        if ($data && in_array($method, ['POST', 'PUT', 'PATCH'])) {
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        }
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        
        if (curl_errno($ch)) {
            echo "   ‚ùå Erreur cURL: " . curl_error($ch) . "\n";
            curl_close($ch);
            return null;
        }
        
        curl_close($ch);
        
        $decodedResponse = json_decode($response, true);
        
        if ($httpCode >= 400) {
            echo "   ‚ö†Ô∏è HTTP {$httpCode}: " . ($decodedResponse['message'] ?? 'Erreur inconnue') . "\n";
        }
        
        return $decodedResponse;
    }

    private function addResult($test, $success, $message)
    {
        $this->results[] = [
            'test' => $test,
            'success' => $success,
            'message' => $message
        ];
    }

    private function showResults()
    {
        echo "üìã R√âSUM√â DES TESTS\n";
        echo str_repeat("=", 60) . "\n";
        
        $total = count($this->results);
        $passed = count(array_filter($this->results, fn($r) => $r['success']));
        $failed = $total - $passed;
        
        foreach ($this->results as $result) {
            $status = $result['success'] ? '‚úÖ' : '‚ùå';
            echo sprintf("%-30s %s %s\n", $result['test'], $status, $result['message']);
        }
        
        echo str_repeat("=", 60) . "\n";
        echo "TOTAL: {$total} tests | R√âUSSIS: {$passed} | √âCHOU√âS: {$failed}\n";
        
        if ($failed === 0) {
            echo "üéâ Tous les tests sont pass√©s avec succ√®s !\n";
        } else {
            echo "‚ö†Ô∏è {$failed} test(s) ont √©chou√©. V√©rifiez les d√©tails ci-dessus.\n";
        }
        
        echo "\nüí° NOTES:\n";
        echo "- Assurez-vous d'avoir des donn√©es de test dans votre base\n";
        echo "- Modifiez les identifiants de connexion si n√©cessaire\n";
        echo "- Certains √©checs peuvent √™tre normaux (ex: confirmation d√©j√† existante)\n";
    }
}

// Configuration
$baseUrl = 'http://localhost/sgreweb/public/api/v1'; // Modifier selon votre environnement

// Lancement des tests
$tester = new ApiTester($baseUrl);
$tester->runAllTests();